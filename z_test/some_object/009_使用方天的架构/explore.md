# new struct



### 风火轮

* 网络一张张图传输过来的

* 有一个缓存池，专门用于存放图片，有一个专门的代码接受图片保存到本地

* 有一组模型，每一个都可以单独地去处理图片，为了防止同时取同一张图片的可能，对每一个模型处理的文件名进行处理，
    * 为了能动态改变模型的个数，首先不能根据模型的个数来设定每一个模型检测的数据？
    * 如果我么的模型是固定的，那么没必要去动态加载，只需要提前设定好要启动的模型的个数

#### 三个组件

* 接受服务，与 java 交互，接收 java 发过来的图片，保存到处理池
    * 不一定保存为 jpeg 格式
    * 文件名可以改为 md5 格式的，方便后面的处理

* 模型处理，读取图片，生成 log 和 xml
    * 处理好各个模型之间的依赖关系，写到配置文件中去，解析配置文件，自动获取其中的依赖关系
    * 只读取一次图片，所有模型放到一个文件中去
    * 改变为利于修改的结构

* 发送服务，读取 xml 给 java 推送结果
    * 每次可以推送多个结果，每次一个发送太多
    * 发送结束的信号，这样就不会出现调度代码和 java 的不一致了


### 比赛 

* 速度快
* 输出为 csv
* 处理中间报错的问题

#### 一个组件

* 只保留模型处理，去除其他两个组件

### 要解决的问题

* 图片个数动态 | 模型个数动态
    * 如何在模型的检测过程中改变各个模型读取图片的规则？
    * 将每个模型读取的文件放到对应的文件夹中去，动态修改的话就是动态的完成文件在文件夹中的分配
    * 读一个文件的时候将这个文件名加锁，这样就能防止其他模型读取
        * 改变了一下文件名，后缀后再再加 .lock 就可以算作加锁，只给加锁的模型使用，其他模型不使用 
        * 加 （1）检测到文件名（2）文件名加 .lock （3）处理加 .lock 的文件名 
    * 试了一下（1）打乱顺序 （2）文件后面加锁 基本可以解决问题，但是有一定的概率会报错
    *       
            
* 多线程多, 进程支持
    * 多进程就是解密时候存到不同的（随机）文件夹中即可
    * 多线程需要目前的模型都支持锁的操作

* 如何让模型动态占用的 GPU 小于给定值
    * 实现 reload 的时候一个 gpu 满了去找另外一个 GPU 
    * 指定（计算）每个 model 使用的最大值，
    * 因为内存而失败的话 try finally : 在报错之前将原图片 unlock 即可

* 使用少量几个模型的时候，如何占用GPU最大化
    * 计算使用模型后的内存占用峰值大小
    * 起来一个模型之后再去启动宁外一个模型，而不是多个模型一起启动

* 不好压缩 GPU 的性能，会保留不小的空余，如何处理？

* 在不同的 GPU 上使用
    * 启动模型之后模型自动扫描所有的 GPU，哪个 GPU 有空闲就在哪个 GPU 上使用

 

 
 
 
 
 
 




